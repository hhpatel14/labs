:sectlinks:
:markup-in-source: verbatim,attributes,quotes
:OCP4_PASSWORD: %ocp4_password%
:CLUSTER_ADMIN_USER: %cluster_admin_user%
:CLUSTER_ADMIN_PASSWORD: %cluster_admin_password%
:APPS_URL: %apps_url%
:API_URL: %api_url%

== Backing up nginx Stateless application

We are going to protect a simple nginx-stateless application. This application has been pre-deployed on your OCP 4 cluster in the `nginx-example` namespace.
In our source OCP 4 cluster terminal, we can see the app running:

[source,bash,role=execute]
----
oc get pods -n nginx-example
----

[source,subs="{markup-in-source}"]
--------------------------------------------------------------------------------
NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-56b7785cc7-vd76k   1/1     Running   0          40m
nginx-deployment-56b7785cc7-z8kg7   1/1     Running   0          40m
--------------------------------------------------------------------------------

Let’s get the route to the application, and bring up the webUI.

[source,bash,role=execute]
----
oc get route -n nginx-example
----
NOTE: You can also click http://my-nginx-nginx-example.{APPS_URL}[here] to open the application.


[source,subs="{markup-in-source}"]
--------------------------------------------------------------------------------
NAME       HOST/PORT                           PATH   SERVICES   PORT   TERMINATION   WILDCARD
my-nginx   my-nginx-nginx-example.{APPS_URL}          my-nginx   8080                 None
--------------------------------------------------------------------------------

image:../screenshots/lab5/nginx-webUI.png[nginx-webUI]

Let’s go ahead and save all app resources in `nginx-running-before.txt` before we create backup.

[source,bash,role=execute]
----
oc get all -n nginx-example > nginx-running-before.txt
----

=== Using Velero to backup application namespace

Let’s go ahead and create a backup of `nginx-example` namespace.
[source,bash,role=execute-2]
----
velero backup create nginx-backup --include-namespaces nginx-example
----

You can check on the backup progress by running the following
[source,bash,role=execute]
----
velero backup describe nginx-backup
----
When the backup `Phase:` is `Completed`., proceed to next section.
[source,bash,role=execute]
----
velero backup describe nginx-backup | grep Phase:
----

=== Viewing backup content in S3 storage
Backup content is stored in S3 storage in the specified content in the prefix location under folder backup inside the backup name's folder.

`<bucket>/<velero-prefix>/backups/<backup-name>/<backup-content>`

[source,bash,role=execute]
----
awsocs s3 ls migstorage/velero/backups/nginx-backup/
----

Content on these files are explained in https://velero.io/docs/v1.7/output-file-format/[Velero Docs].

=== Simulate a disaster
When the backup `Phase:` is `Completed`, we'll proceed to simulate a disaster by deleting the namespace.
[source,bash,role=execute]
----
oc delete ns nginx-example
----

Check that the application is no longer available.

NOTE: Click http://my-nginx-nginx-example.{APPS_URL}[here] to open the application.

When application is no longer available, proceed to next section.

=== Restoring deleted application
We can restore applications deleted earlier by restoring from the backup we created.
[source,bash,role=execute]
----
velero restore create nginx-restore --from-backup nginx-backup
----

We can check when the restore is completed by running the following. The restore is complete when `Phase:` is `Completed`.
[source,bash,role=execute]
----
velero restore describe nginx-restore
----

Wait until pods become available.
[source,bash,role=execute]
----
oc get pods -n nginx-example
----

[source,subs="{markup-in-source}"]
--------------------------------------------------------------------------------
NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-56b7785cc7-g8xfj   1/1     Running   0          47s
nginx-deployment-56b7785cc7-q824n   1/1     Running   0          47s
--------------------------------------------------------------------------------

Verify webUI is available in the restored application.

NOTE: Click http://my-nginx-nginx-example.{APPS_URL}[here] to open the application.

Let’s go ahead and collect restored nginx application resources in `nginx-running-after.txt` after restore `Phase:` is `Completed`.
[source,bash,role=execute]
----
oc get all -n nginx-example > nginx-running-after.txt
----

Compare `nginx-running-before.txt` and `nginx-running-after.txt` and verify resources.